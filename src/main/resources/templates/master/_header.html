<!-- Header Fragment -->
<div th:fragment="header">
  <!-- Th√™m Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
  <nav class="navbar navbar-expand-lg navbar-light bg-light custom-navbar">
    <!-- Logo + brand -->
    <div class="container">
      <div class="d-flex align-items-center">
        <img
          id="avatarHeader"
          src="/img/OIP.jpg"
          alt="Avatar"
          width="40"
          height="40"
          class="rounded-circle me-2 border"
          style="object-fit: cover"
        />
        <a class="navbar-brand" href="/">Vaccines for children</a>
      </div>

      <!-- Toggle menu cho mobile -->
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Navbar b√™n trong -->
      <div
        class="collapse navbar-collapse justify-content-between"
        id="navbarNav"
      >
        <!-- Nh√≥m menu b√™n tr√°i -->
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" th:href="@{/about}">‚ÑπÔ∏è Gi·ªõi thi·ªáu</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" th:href="@{/services}">‚òé D·ªãch v·ª•</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" th:href="@{/vaccine-list}"
              >üìñ B·∫£ng gi√°</a
            >
          </li>
          <li class="nav-item" sec:authorize="isAuthenticated()">
            <a class="nav-link" th:href="@{/appointments}"
              >ƒê·∫∑t l·ªãch ti√™m</a
            >
          </li>
        </ul>

        <!-- Nh√≥m b√™n ph·∫£i -->
        <ul class="navbar-nav d-flex align-items-center">
          <li class="nav-item">
            <button id="darkModeToggle" class="btn btn-link nav-link">
              üåô
            </button>
          </li>

          <!-- Dropdown th√¥ng b√°o -->
          <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
            <a class="nav-link dropdown-toggle position-relative" href="#" id="notificationDropdown" role="button" data-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-bell-fill"></i>
              <span class="notification-badge">
                0
              </span>
            </a>
            <div class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationDropdown" style="width: 320px; max-height: 400px; overflow-y: auto;">
              <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                <h6 class="dropdown-header m-0">Th√¥ng b√°o m·ªõi</h6>
                <a href="#" id="markAllAsRead" class="text-decoration-none small">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc t·∫•t c·∫£</a>
              </div>
              
              <div id="notificationsList">
                <!-- Th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
                <div class="dropdown-item text-center p-3">
                  <p class="text-muted mb-0">ƒêang t·∫£i th√¥ng b√°o...</p>
                </div>
              </div>
              
              <div class="dropdown-divider mb-0"></div>
              <a class="dropdown-item text-center p-2" th:href="@{/user/notifications}">
                Xem t·∫•t c·∫£ th√¥ng b√°o
              </a>
            </div>
          </li>

          <!-- Ch∆∞a ƒëƒÉng nh·∫≠p -->
          <li class="nav-item" sec:authorize="isAnonymous()">
            <a
              class="btn btn-primary mx-1"
              th:href="@{/auth/login}"
              role="button"
              >ƒêƒÉng nh·∫≠p</a
            >
          </li>
          <li class="nav-item" sec:authorize="isAnonymous()">
            <a
              class="btn btn-success mx-1"
              th:href="@{/auth/register}"
              role="button"
              >ƒêƒÉng k√Ω</a
            >
          </li>

          <!-- ƒê√£ ƒëƒÉng nh·∫≠p -->
          <li
            class="nav-item dropdown"
            id="avatarDropdown"
            sec:authorize="isAuthenticated()"
          >
            <a
              class="nav-link dropdown-toggle d-flex align-items-center"
              href="#"
              id="userDropdown"
              role="button"
              data-toggle="dropdown"
              aria-expanded="false"
            >
              <img
                id="navbarAvatar"
                alt="Avatar"
                class="rounded-circle me-2"
                width="32"
                height="32"
              />
            </a>
            <div class="dropdown-menu dropdown-menu-end">
              <a class="dropdown-item" th:href="@{/auth/profile}">‚ÑπÔ∏è Profile</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" th:href="@{/payments/history}"
                >üí∞ L·ªãch s·ª≠ thanh to√°n</a
              >
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" th:href="@{/appointments/history}">
                üìÖ L·ªãch s·ª≠ ƒë·∫∑t l·ªãch
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="/auth/change-password"
                  ><i class="bi bi-key"></i> ƒê·ªïi m·∫≠t kh·∫©u</a
              >
              <div class="dropdown-divider"></div>
              <form th:action="@{/auth/logout}" method="post">
                <button type="submit" class="dropdown-item">
                  üö™ ƒêƒÉng xu·∫•t
                </button>
              </form>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- CSS cho dropdown th√¥ng b√°o v√† dark mode -->
  <style>
    /* CSS cho dropdown th√¥ng b√°o */
    .notification-dropdown {
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.1);
    }
    .notification-dropdown .dropdown-item {
      white-space: normal;
      transition: background-color 0.2s;
    }
    .notification-dropdown .dropdown-item:hover {
      background-color: #f8f9fa;
    }
    .notification-dropdown .dropdown-item.unread {
      background-color: #f0f7ff;
    }
    
    /* CSS cho badge th√¥ng b√°o */
    .notification-badge {
      position: absolute;
      top: 0px;
      right: 0px;
      transform: translate(25%, -25%);
      display: inline-block;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      font-size: 11px;
      font-weight: 700;
      line-height: 18px;
      text-align: center;
      white-space: nowrap;
      vertical-align: middle;
      border-radius: 10px;
      background-color: #dc3545;
      color: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* CSS cho Dark Mode */
    body.dark-mode {
      background-color: #212529;
      color: #f8f9fa;
    }
    
    body.dark-mode .navbar {
      background-color: #343a40 !important;
    }
    
    body.dark-mode .navbar-light .navbar-brand,
    body.dark-mode .navbar-light .nav-link {
      color: #f8f9fa;
    }
    
    body.dark-mode .dropdown-menu {
      background-color: #343a40;
      color: #f8f9fa;
      border-color: #495057;
    }
    
    body.dark-mode .dropdown-item {
      color: #f8f9fa;
    }
    
    body.dark-mode .dropdown-item:hover {
      background-color: #495057;
    }
    
    body.dark-mode .notification-dropdown .dropdown-item.unread {
      background-color: #2b3035;
    }
    
    body.dark-mode .card,
    body.dark-mode .modal-content {
      background-color: #343a40;
      color: #f8f9fa;
      border-color: #495057;
    }
    
    body.dark-mode .form-control,
    body.dark-mode .form-select {
      background-color: #495057;
      border-color: #6c757d;
      color: #f8f9fa;
    }
  </style>
  
  <!-- Scripts cho Dark Mode v√† Dropdown -->
  <script>
    // Dark Mode Toggle
    document.addEventListener('DOMContentLoaded', function() {
      // 1. X·ª≠ l√Ω Dark Mode
      const darkModeToggle = document.getElementById('darkModeToggle');
      if (darkModeToggle) {
        darkModeToggle.addEventListener('click', function() {
          document.body.classList.toggle('dark-mode');
          const isDarkMode = document.body.classList.contains('dark-mode');
          localStorage.setItem('darkMode', isDarkMode);
          this.innerHTML = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
          
          // C·∫≠p nh·∫≠t c√°c ph·∫ßn t·ª≠ CSS t√πy ch·ªânh cho dark mode
          updateDarkModeStyles(isDarkMode);
        });
        
        // Ki·ªÉm tra ch·∫ø ƒë·ªô t·ªëi khi trang t·∫£i
        const savedDarkMode = localStorage.getItem('darkMode') === 'true';
        if (savedDarkMode) {
          document.body.classList.add('dark-mode');
          darkModeToggle.innerHTML = '‚òÄÔ∏è';
          updateDarkModeStyles(true);
        }
      }
      
      // H√†m c·∫≠p nh·∫≠t c√°c style theo dark mode
      function updateDarkModeStyles(isDark) {
        // C·∫≠p nh·∫≠t c√°c style t√πy ch·ªânh d·ª±a tr√™n tr·∫°ng th√°i dark mode
        if (isDark) {
          document.documentElement.style.setProperty('--bs-dropdown-bg', '#343a40');
          document.documentElement.style.setProperty('--bs-dropdown-color', '#f8f9fa');
          document.documentElement.style.setProperty('--bs-dropdown-link-hover-bg', '#495057');
        } else {
          document.documentElement.style.setProperty('--bs-dropdown-bg', '');
          document.documentElement.style.setProperty('--bs-dropdown-color', '');
          document.documentElement.style.setProperty('--bs-dropdown-link-hover-bg', '');
        }
      }
      
      // 2. ƒê·∫£m b·∫£o c√°c dropdown ho·∫°t ƒë·ªông
      function initDropdowns() {
        // Ki·ªÉm tra jQuery v√† plugin dropdown c√≥ s·∫µn kh√¥ng
        if (typeof $ !== 'undefined' && typeof $.fn.dropdown !== 'undefined') {
          // Kh·ªüi t·∫°o t·∫•t c·∫£ c√°c dropdown
          $('.dropdown-toggle').dropdown();
          
          // ƒê·∫∑c bi·ªát x·ª≠ l√Ω cho notificationDropdown
          $('#notificationDropdown').off('click.bs.dropdown').on('click.bs.dropdown', function() {
            // L·∫•y ID hi·ªán t·∫°i c·ªßa ng∆∞·ªùi d√πng
            const currentUserId = getCurrentUserId();
            if (currentUserId) {
              fetchNotifications(currentUserId);
            }
          });
          
          // ƒê·∫£m b·∫£o dropdown s·ª± ki·ªán click ho·∫°t ƒë·ªông cho c√°c dropdown kh√°c
          $('.dropdown-toggle:not(#notificationDropdown)').off('click.bs.dropdown').on('click.bs.dropdown', function(e) {
            $(this).dropdown('toggle');
            e.stopPropagation();
            return false;
          });
        } else {
          console.warn('jQuery ho·∫∑c dropdown plugin kh√¥ng ƒë∆∞·ª£c t√¨m th·∫•y');
        }
      }
      
      // Th√™m CSS cho animation quay icon khi ƒëang t·∫£i
      $('<style>.spinner { animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>').appendTo('head');
      
      // Kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu
      initDropdowns();
      
      // ƒê·∫£m b·∫£o c√°c dropdown v·∫´n ho·∫°t ƒë·ªông sau khi ajax ho√†n th√†nh ho·∫∑c page thay ƒë·ªïi
      $(document).ajaxComplete(function() {
        initDropdowns();
      });
    });
  </script>
  
  <!-- Script cho h·ªá th·ªëng th√¥ng b√°o -->
  <script th:inline="javascript">
    $(document).ready(function() {
      // Ch·ªâ kh·ªüi t·∫°o h·ªá th·ªëng th√¥ng b√°o n·∫øu ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p
      if ($('[sec\\:authorize="isAuthenticated()"]').length) {
        try {
          let currentUser = null;
          // Kh·ªüi t·∫°o bi·∫øn ƒë·∫øm l·ªói
          window.notificationErrorCount = 0;
          
          // Th·ª≠ l·∫•y ID ng∆∞·ªùi d√πng t·ª´ session
          /*[+
            if(${#authentication != null && #authentication.principal != null}) {
              currentUser = ${#authentication.principal.id};
            }
          +]*/
          
          if (currentUser) {
            console.log("ƒê√£ t√¨m th·∫•y ng∆∞·ªùi d√πng ID:", currentUser);
            // ·∫®n badge ban ƒë·∫ßu
            $('.notification-badge').hide();
            
            // Kh·ªüi t·∫°o s·ª± ki·ªán
            setupNotificationEvents(currentUser);
            
            // T·∫£i th√¥ng b√°o ban ƒë·∫ßu
            fetchNotifications(currentUser);
            
            // Thi·∫øt l·∫≠p interval ƒë·ªÉ ki·ªÉm tra th√¥ng b√°o m·ªõi
            setInterval(function() {
              fetchNotifications(currentUser);
            }, 300000);
          }
        } catch (e) {
          console.error('L·ªói kh·ªüi t·∫°o h·ªá th·ªëng th√¥ng b√°o:', e);
        }
      }
      
      // Thi·∫øt l·∫≠p s·ª± ki·ªán cho h·ªá th·ªëng th√¥ng b√°o
      function setupNotificationEvents(userId) {
        // N√∫t ƒë√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc
        $('#markAllAsRead').on('click', function(e) {
          e.preventDefault();
          markAllAsRead(userId);
        });
      }
      
      // Kh·ªüi t·∫°o bi·∫øn ƒë·∫øm l·ªói
      window.notificationErrorCount = 0;
      
      // L·∫•y th√¥ng b√°o t·ª´ server
      function fetchNotifications(userId) {
        if (!userId) {
          console.error('Kh√¥ng t√¨m th·∫•y ID ng∆∞·ªùi d√πng ƒë·ªÉ l·∫•y th√¥ng b√°o');
          $('#notificationsList').html('<div class="dropdown-item text-center p-3"><p class="text-muted mb-0">Kh√¥ng th·ªÉ t·∫£i th√¥ng b√°o</p></div>');
          return;
        }
        
        // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i
        $('#notificationsList').html('<div class="dropdown-item text-center p-3"><p class="text-muted mb-0"><i class="bi bi-arrow-repeat spinner"></i> ƒêang t·∫£i th√¥ng b√°o...</p></div>');
        
        // Ki·ªÉm tra ƒë·∫øm l·ªói
        if (window.notificationErrorCount >= 3) {
          console.log("ƒê√£ th·ª≠ l·∫•y th√¥ng b√°o nhi·ªÅu l·∫ßn th·∫•t b·∫°i, t·∫°m d·ª´ng ƒë·ªÉ tr√°nh g·ª≠i qu√° nhi·ªÅu request");
          $('#notificationsList').html('<div class="dropdown-item text-center p-3"><p class="text-muted mb-0">Kh√¥ng th·ªÉ t·∫£i th√¥ng b√°o</p></div>');
          return;
        }
        
        // G·ªçi API l·∫•y th√¥ng b√°o
        $.ajax({
          url: '/notifications/' + userId,
          type: 'GET',
          timeout: 10000,  // Timeout sau 10 gi√¢y
          success: function(notifications) {
            // Reset error count khi th√†nh c√¥ng
            window.notificationErrorCount = 0;
            displayNotifications(notifications);
          },
          error: function(error) {
            // TƒÉng ƒë·∫øm l·ªói
            window.notificationErrorCount = (window.notificationErrorCount || 0) + 1;
            console.error('L·ªói khi t·∫£i th√¥ng b√°o:', error);
            $('#notificationsList').html('<div class="dropdown-item text-center p-3"><p class="text-muted mb-0">Kh√¥ng th·ªÉ t·∫£i th√¥ng b√°o</p></div>');
          }
        });
      }
      
      // Hi·ªÉn th·ªã th√¥ng b√°o
      function displayNotifications(notifications) {
        const $list = $('#notificationsList');
        $list.empty();
        
        if (!notifications || notifications.length === 0) {
          $list.html('<div class="dropdown-item text-center p-3"><p class="text-muted mb-0">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</p></div>');
          $('.notification-badge').hide();
          return;
        }
        
        // ƒê·∫øm th√¥ng b√°o ch∆∞a ƒë·ªçc
        const unreadCount = notifications.filter(n => !n.status).length;
        
        // C·∫≠p nh·∫≠t badge
        if (unreadCount > 0) {
          $('.notification-badge').text(unreadCount).show();
        } else {
          $('.notification-badge').hide();
        }
        
        // Hi·ªÉn th·ªã c√°c th√¥ng b√°o
        notifications.slice(0, 5).forEach(function(notification) {
          const isUnread = !notification.status;
          const title = notification.title || 'Th√¥ng b√°o';
          const icon = getNotificationIcon(notification);
          
          $list.append(`
            <a class="dropdown-item p-2 border-bottom ${isUnread ? 'unread' : ''}" href="#" data-id="${notification.id}">
              <div class="d-flex">
                <div class="flex-shrink-0">
                  ${icon}
                </div>
                <div class="ms-3">
                  <div class="d-flex justify-content-between">
                    <p class="mb-0 ${isUnread ? 'fw-bold' : ''}">${title}</p>
                    <small class="text-muted">${formatTimeAgo(notification.sentAt)}</small>
                  </div>
                  <p class="text-muted mb-0 small">${notification.message}</p>
                </div>
              </div>
            </a>
          `);
        });
        
        // Th√™m s·ª± ki·ªán click cho c√°c th√¥ng b√°o
        $list.find('a[data-id]').on('click', function(e) {
          e.preventDefault();
          const notificationId = $(this).data('id');
          markAsRead(notificationId);
        });
      }
      
      // L·∫•y icon d·ª±a tr√™n lo·∫°i th√¥ng b√°o
      function getNotificationIcon(notification) {
        const type = notification.type || '';
        
        if (type === 'VACCINE' || notification.message.includes('v·∫Øc-xin'))
          return '<i class="bi bi-syringe text-success fs-5"></i>';
        else if (type === 'PACKAGE' || notification.message.includes('g√≥i'))
          return '<i class="bi bi-box-seam text-warning fs-5"></i>';
        else if (type === 'PAYMENT' || notification.message.includes('thanh to√°n'))
          return '<i class="bi bi-credit-card text-primary fs-5"></i>';
        else
          return '<i class="bi bi-bell-fill text-info fs-5"></i>';
      }
      
      // ƒê·ªãnh d·∫°ng th·ªùi gian
      function formatTimeAgo(timestamp) {
        if (!timestamp) return '';
        
        const now = new Date();
        const time = new Date(timestamp);
        const diff = Math.floor((now - time) / 1000);
        
        if (diff < 60) return 'V·ª´a xong';
        if (diff < 3600) return Math.floor(diff / 60) + ' ph√∫t tr∆∞·ªõc';
        if (diff < 86400) return Math.floor(diff / 3600) + ' gi·ªù tr∆∞·ªõc';
        
        return time.toLocaleDateString('vi-VN');
      }
      
      // ƒê√°nh d·∫•u m·ªôt th√¥ng b√°o ƒë√£ ƒë·ªçc
      function markAsRead(notificationId) {
        $.ajax({
          url: '/notifications/' + notificationId + '/read',
          type: 'PUT',
          success: function() {
            // T·∫£i l·∫°i th√¥ng b√°o sau khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
            fetchNotifications(getCurrentUserId());
          },
          error: function(error) {
            console.error('L·ªói khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc:', error);
          }
        });
      }
      
      // ƒê√°nh d·∫•u t·∫•t c·∫£ th√¥ng b√°o ƒë√£ ƒë·ªçc
      function markAllAsRead(userId) {
        $.ajax({
          url: '/notifications/read-all/' + userId,
          type: 'PUT',
          success: function() {
            // T·∫£i l·∫°i th√¥ng b√°o sau khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
            fetchNotifications(userId);
          },
          error: function(error) {
            console.error('L·ªói khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc:', error);
          }
        });
      }
      
      // L·∫•y ID ng∆∞·ªùi d√πng hi·ªán t·∫°i
      function getCurrentUserId() {
        let currentUser = null;
        /*[+
          if(${#authentication != null && #authentication.principal != null}) {
            currentUser = ${#authentication.principal.id};
          }
        +]*/
        return currentUser;
      }
    });
  </script>
  
  <!-- V√πng ch·ª©a toast th√¥ng b√°o -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div class="toast-container"></div>
  </div>
</div>
